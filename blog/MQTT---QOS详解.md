## MQTT---QOS详解

### 什么是QOS

在MQTT（Message Queuing Telemetry Transport）协议中，QoS（Quality of Service，服务质量）指的是在消息传递过程中对消息的可靠性和传输保证的级别。具体来说，MQTT协议定义了三个不同的QoS级别：0、1和2。

1. QoS 0（At most once，至多一次）：消息尽力地被传递给接收者，但无法保证可靠性。消息可能会丢失或重复传递，通过这种级别交付的消息不能保证到达接收者。
2. QoS 1（At least once，至少一次）：确保每条消息至少被传递一次，但可能会被重复传递。发送者在发送消息后会等待接收者的确认。如果确认超时或丢失，发送者会重新发送消息。
3. QoS 2（Exactly once，恰好一次）：提供最高级别的可靠性。确保每条消息会被精确地传递一次，没有重复或丢失。这个级别通过发送者和接收者进行握手来实现，并使用消息ID和确认ID来跟踪和确认消息传递。

选择适当的QoS级别取决于应用程序的需求。如果应用程序能够容忍一些消息丢失或重复传递，可以选择QoS 0。如果可靠性很重要，但可以容忍一些重复传递，可以选择QoS 1。如果要求确保精确一次的传递，可以选择QoS 2。

在一个完整的从发布者到订阅者的消息投递流程中，QoS 等级是由发布者在 PUBLISH 报文中指定的，**大部分情况下 Broker 向订阅者转发消息时都会维持原始的 QoS 不变**。不过也有一些例外的情况，根据订阅者的订阅要求，消息的 QoS 等级可能会在转发的时候发生降级。

例如，订阅者在订阅时要求 Broker 可以向其转发的消息的最大 QoS 等级为 QoS 1，那么后续所有 QoS 2 消息都会降级至 QoS 1 转发给此订阅者，而所有 QoS 0 和 QoS 1 消息则会保持原始的 QoS 等级转发。



#### QOS 0 - 最多交付一次

QOS 0是最低的QOS等级。在这个等级下，消息即发即弃，消息的可靠性完全依赖于底层的TCP协议

##### 为什么会出现消息丢失：

TCP 只能保证在连接稳定不关闭的情况下消息的可靠到达，一旦出现连接关闭、重置，仍有可能丢失当前处于网络链路或操作系统底层缓冲区中的消息。这也是 QoS 0 消息最主要的丢失场景。



#### QOS 1 - 至少交付一次

在这个QOS等级下 保证了消息的到达，这个级别下加入了应答与重传机制，发送方（不一定是publisher，可能是mqtt服务器，即broker）只有收到接收方PUBACK报文后才认为消息投递成功，在此之前，发送方需要存储该 PUBLISH 报文以便下次重传。

QOS 1 需要在PUBLISH报文中设置PacketID 相应的PUBACK报文会使用与PUBLISH报文相同的PacketID 方便删除PUBLISH报文缓存

##### 为什么会出现消息重复：

简单来说  PUBACK报文超时或者丢失 会触发发送方的重传机制

**Notice**:客户端不可以简单的以PacketID作为幂等的判断条件，因为PacketID可重用



#### QOS 2 - 只交付一次

QoS 2 解决了 QoS 0、1 消息可能丢失或者重复的问题，但相应地，它也带来了最复杂的交互流程和最高的开销。每一次的 QoS 2 消息投递，都要求发送方与接收方进行至少两次请求/响应流程。

1. 首先，发送方存储并发送 QoS 为 2 的 PUBLISH 报文以启动一次 QoS 2 消息的传输，然后等待接收方回复 PUBREC 报文。这一部分与 QoS 1 基本一致，只是响应报文从 PUBACK 变成了 PUBREC。
2. 当发送方收到 PUBREC 报文，即可确认对端已经收到了 PUBLISH 报文，发送方将**不再需要重传**这个报文，并且也**不能再重传**这个报文。所以此时发送方可以删除本地存储的 PUBLISH 报文，然后发送一个 PUBREL 报文，通知对端自己准备将本次使用的 Packet ID 标记为可用了。与 PUBLISH 报文一样，我们需要确保 PUBREL 报文到达对端，所以也需要一个响应报文，并且这个 PUBREL 报文需要被存储下来以便后续重传。
3. 当接收方收到 PUBREL 报文，也可以确认在这一次的传输流程中不会再有重传的 PUBLISH 报文到达，因此回复 PUBCOMP 报文表示自己也准备好将当前的 Packet ID 用于新的消息了。
4. 当发送方收到 PUBCOMP 报文，这一次的 QoS 2 消息传输就算正式完成了。在这之后，发送方可以再次使用当前的 Packet ID 发送新的消息，而接收方再次收到使用这个 Packet ID 的 PUBLISH 报文时，也会将它视为一个全新的消息。



### 如何选择QOS等级

这三种等级中，QOS 2看似是最完美的方案 但由于QOS 2相较于前两个等级多了若干确认过程 性能相对较差 具体测试中以 EMQX 为例，在相同的硬件配置下进行点对点通信，通常 QoS 0 与 QoS 1 能够达到的吞吐比较接近，不过 QoS 1 的 CPU 占用会略高于 QoS 0，负载较高时，QoS 1 的消息延迟也会进一步增加。而 QoS 2 能够达到的吞吐一般仅为 QoS 0、1 的一半左右。 

可以根据具体使用场景选择QOS等级